<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="/css/boardCSS.css" />
	<script src="/socket.io/socket.io.js"></script>
    <!-- export this script later -->
    <script>
    	var socket = io.connect();

    	var constraints = { audio: true };
		navigator.mediaDevices.getUserMedia(constraints).then(function(mediaStream) {
		    var mediaRecorder = new MediaRecorder(mediaStream);
		    mediaRecorder.onstart = function(e) {
		        this.chunks = [];
		    };
		    mediaRecorder.ondataavailable = function(e) {
		        this.chunks.push(e.data);
		    };
		    mediaRecorder.onstop = function(e) {
		        var blob = new Blob(this.chunks, { 'type' : 'audio/ogg; codecs=opus' });
		        socket.emit('radio', blob);
		    };

		    // Start recording
			mediaRecorder.start();

		    // Stop recording after 5 seconds and broadcast it to server
		    setInterval(function() {
		        mediaRecorder.stop()
		        mediaRecorder.start();
		    }, 300);
		});

		// When the client receives a voice message it will play the sound
		socket.on('voice', function(arrayBuffer) {
		    var blob = new Blob([arrayBuffer], { 'type' : 'audio/ogg; codecs=opus' });
		    var audio = document.createElement('audio');
		    audio.src = window.URL.createObjectURL(blob);
		    audio.play();
		});

    	console.log('hello')
    	var url = <%- JSON.stringify(url) %>;
    	var key = <%- JSON.stringify(key) %>;
    	var username = <%- JSON.stringify(user) %>;
        socket.on('socketid', function (data) {
            document.getElementById('message1').value = data;
        });
        socket.emit('message', { tryKey : key, message : 'connected to chat', user : username, url : url });
        function sendMessage() {
        	var messageData =  document.getElementById('messageText').value;
        	socket.emit('message', { tryKey : key, message : messageData, user : username, url : url });
        }
        socket.on('hi', function (data) {
        	console.log(data);
        	console.log('hello');
        });
        socket.on('allUsersMessage', function(data) {
        	console.log(data.message + ' ' + data.user);
        })
    </script>
</head>
<body>
	<p></p>
	<div id='message1'></div>
	<p>This is the board template!</p>
	<div class='chat'>
		<input type="text" class='chat-name' placeholder='enter your name'>
		<div class='chat-messages'>
			<div class='chat-message'>
				Alex: hello there
			</div>
			<div class='chat-message'>
				Billy: hello
			</div>
		</div>
		<textarea placeholder='Type your message' id='messageText'></textarea>
		<div class='chat-status'>status: <span>idle</span></div>
		<button type="button" onclick='sendMessage();'>Click Me!</button>
	</div>
</body>
</html>